---
import BaseLayout from '../layouts/BaseLayout.astro';

const structuredData = {
	"@context": "https://schema.org",
	"@type": "WebApplication",
	"name": "Psychedelic Readiness Assessment",
	"description": "Comprehensive self-assessment questionnaire to evaluate readiness for psychedelic journey facilitation",
	"url": "https://disendarkenment.com/readiness-assessment",
	"applicationCategory": "HealthApplication",
	"operatingSystem": "Web Browser",
	"offers": {
		"@type": "Offer",
		"price": "0",
		"priceCurrency": "USD"
	}
};
---

<BaseLayout 
	title="Enhanced Readiness Assessment - Disendarkenment" 
	description="Advanced multi-step assessment to evaluate your preparedness for psychedelic journey facilitation with personalized recommendations and progress tracking."
	structuredData={structuredData}
>
	<!-- Hero Section -->
	<section class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 text-white py-16">
		<div class="container mx-auto px-4">
			<div class="max-w-4xl mx-auto text-center">
				<h1 class="text-4xl md:text-5xl font-bold mb-6">Enhanced Readiness Assessment</h1>
				<p class="text-xl text-indigo-100 mb-8">
					Advanced multi-step evaluation with personalized recommendations and progress tracking
				</p>
				<div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 max-w-2xl mx-auto">
					<p class="text-indigo-100 mb-4">
						This comprehensive assessment uses advanced scoring algorithms to provide detailed insights into your readiness for psychedelic therapy.
					</p>
					<p class="text-sm text-indigo-200">
						Estimated completion time: 15-20 minutes • Progress saved automatically
					</p>
				</div>
			</div>
		</div>
	</section>

	<!-- Progress Indicator -->
	<section class="py-8 bg-white border-b sticky top-0 z-40 shadow-sm">
		<div class="container mx-auto px-4">
			<div class="max-w-4xl mx-auto">
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-lg font-semibold text-gray-900">Assessment Progress</h2>
					<span id="progress-text" class="text-sm text-gray-600">Step 1 of 4</span>
				</div>
				<div class="w-full bg-gray-200 rounded-full h-3">
					<div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 25%"></div>
				</div>
				<div class="flex justify-between mt-2 text-xs text-gray-500">
					<span>Mental Health</span>
					<span>Intentions</span>
					<span>Support</span>
					<span>Experience</span>
				</div>
			</div>
		</div>
	</section>

	<!-- Assessment Form -->
	<section class="py-16 bg-white">
		<div class="container mx-auto px-4">
			<div class="max-w-4xl mx-auto">
				<form id="readiness-form" class="space-y-12">
					<!-- Navigation Buttons -->
					<div class="flex justify-between mb-8">
						<button type="button" id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center" disabled>
							<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
							</svg>
							Previous
						</button>
						<button type="button" id="next-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex items-center">
							Next
							<svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
							</svg>
						</button>
						<button type="submit" id="submit-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 hidden flex items-center">
							<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
							</svg>
							Complete Assessment
						</button>
					</div>

					<!-- Step 1: Mental Health & Stability -->
					<div class="assessment-step active" data-step="1">
						<div class="bg-blue-50 rounded-lg p-8">
							<h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
								<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
									<span class="text-blue-600 font-semibold">1</span>
								</div>
								Mental Health & Emotional Stability
							</h2>
							
							<div class="space-y-8">
								<div class="question-group" data-required="true">
									<label class="block text-lg font-medium text-gray-900 mb-4">
										How would you describe your current mental health status?
										<span class="text-red-500">*</span>
									</label>
									<div class="space-y-3">
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="mental_health" value="excellent" class="mt-1 mr-4" data-score="25">
											<div>
												<span class="font-medium text-gray-900">Excellent</span>
												<p class="text-sm text-gray-600">I feel mentally stable, resilient, and emotionally balanced</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="mental_health" value="good" class="mt-1 mr-4" data-score="20">
											<div>
												<span class="font-medium text-gray-900">Good</span>
												<p class="text-sm text-gray-600">Generally stable with minor occasional challenges that I manage well</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="mental_health" value="fair" class="mt-1 mr-4" data-score="10">
											<div>
												<span class="font-medium text-gray-900">Fair</span>
												<p class="text-sm text-gray-600">Some ongoing challenges but manageable with support</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="mental_health" value="poor" class="mt-1 mr-4" data-score="0">
											<div>
												<span class="font-medium text-gray-900">Poor</span>
												<p class="text-sm text-gray-600">Significant ongoing mental health challenges requiring professional support</p>
											</div>
										</label>
									</div>
								</div>

								<div class="question-group" data-required="true">
									<label class="block text-lg font-medium text-gray-900 mb-4">
										Are you currently taking any psychiatric medications?
										<span class="text-red-500">*</span>
									</label>
									<div class="space-y-3">
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="medications" value="none" class="mt-1 mr-4" data-score="5">
											<div>
												<span class="font-medium text-gray-900">No medications</span>
												<p class="text-sm text-gray-600">Not currently taking any psychiatric medications</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="medications" value="stable" class="mt-1 mr-4" data-score="10">
											<div>
												<span class="font-medium text-gray-900">Stable regimen</span>
												<p class="text-sm text-gray-600">Yes, stable on current medications for 3+ months</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="medications" value="recent_changes" class="mt-1 mr-4" data-score="-5">
											<div>
												<span class="font-medium text-gray-900">Recent changes</span>
												<p class="text-sm text-gray-600">Yes, with recent changes in the last 3 months</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="medications" value="contraindicated" class="mt-1 mr-4" data-score="-25">
											<div>
												<span class="font-medium text-gray-900">Contraindicated medications</span>
												<p class="text-sm text-gray-600">Yes, taking MAOIs, lithium, or tramadol</p>
											</div>
										</label>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Step 2: Intentions & Motivations -->
					<div class="assessment-step" data-step="2">
						<div class="bg-green-50 rounded-lg p-8">
							<h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
								<div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
									<span class="text-green-600 font-semibold">2</span>
								</div>
								Intentions & Motivations
							</h2>
							
							<div class="space-y-8">
								<div class="question-group" data-required="true">
									<label class="block text-lg font-medium text-gray-900 mb-4">
										What is your primary motivation for pursuing psychedelic therapy?
										<span class="text-red-500">*</span>
									</label>
									<div class="space-y-3">
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="motivation" value="healing" class="mt-1 mr-4" data-score="20">
											<div>
												<span class="font-medium text-gray-900">Healing from trauma</span>
												<p class="text-sm text-gray-600">Processing and healing from emotional wounds or traumatic experiences</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="motivation" value="depression" class="mt-1 mr-4" data-score="18">
											<div>
												<span class="font-medium text-gray-900">Mental health treatment</span>
												<p class="text-sm text-gray-600">Treatment for depression, anxiety, or other mental health conditions</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="motivation" value="growth" class="mt-1 mr-4" data-score="15">
											<div>
												<span class="font-medium text-gray-900">Personal growth</span>
												<p class="text-sm text-gray-600">Self-discovery, personal development, and expanding consciousness</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="motivation" value="spiritual" class="mt-1 mr-4" data-score="12">
											<div>
												<span class="font-medium text-gray-900">Spiritual exploration</span>
												<p class="text-sm text-gray-600">Deepening spiritual connection and understanding</p>
											</div>
										</label>
									</div>
								</div>

								<div class="question-group">
									<label for="specific_goals" class="block text-lg font-medium text-gray-900 mb-4">
										Please describe your specific goals or what you hope to achieve:
									</label>
									<textarea 
										id="specific_goals" 
										name="specific_goals" 
										rows="4" 
										class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
										placeholder="Share your hopes, goals, or areas you'd like to explore..."
									></textarea>
								</div>
							</div>
						</div>
					</div>

					<!-- Step 3: Support System -->
					<div class="assessment-step" data-step="3">
						<div class="bg-purple-50 rounded-lg p-8">
							<h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
								<div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
									<span class="text-purple-600 font-semibold">3</span>
								</div>
								Support System & Environment
							</h2>
							
							<div class="space-y-8">
								<div class="question-group" data-required="true">
									<label class="block text-lg font-medium text-gray-900 mb-4">
										Do you have a trusted support person who can be present during your journey?
										<span class="text-red-500">*</span>
									</label>
									<div class="space-y-3">
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="support_person" value="yes_experienced" class="mt-1 mr-4" data-score="25">
											<div>
												<span class="font-medium text-gray-900">Yes, experienced sitter</span>
												<p class="text-sm text-gray-600">I have someone experienced with psychedelic support</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="support_person" value="yes_willing" class="mt-1 mr-4" data-score="15">
											<div>
												<span class="font-medium text-gray-900">Yes, willing to learn</span>
												<p class="text-sm text-gray-600">I have someone willing to learn about trip sitting</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="support_person" value="no" class="mt-1 mr-4" data-score="0">
											<div>
												<span class="font-medium text-gray-900">No</span>
												<p class="text-sm text-gray-600">I don't have anyone available</p>
											</div>
										</label>
									</div>
								</div>

								<div class="question-group" data-required="true">
									<label class="block text-lg font-medium text-gray-900 mb-4">
										Do you have a safe, comfortable environment for your journey?
										<span class="text-red-500">*</span>
									</label>
									<div class="space-y-3">
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="environment" value="ideal" class="mt-1 mr-4" data-score="15">
											<div>
												<span class="font-medium text-gray-900">Ideal setting</span>
												<p class="text-sm text-gray-600">Private, comfortable, and prepared space</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="environment" value="good" class="mt-1 mr-4" data-score="10">
											<div>
												<span class="font-medium text-gray-900">Good setting</span>
												<p class="text-sm text-gray-600">Safe and comfortable with minor preparations needed</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="environment" value="uncertain" class="mt-1 mr-4" data-score="0">
											<div>
												<span class="font-medium text-gray-900">Uncertain</span>
												<p class="text-sm text-gray-600">Not sure about appropriate setting</p>
											</div>
										</label>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Step 4: Experience Level -->
					<div class="assessment-step" data-step="4">
						<div class="bg-yellow-50 rounded-lg p-8">
							<h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
								<div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
									<span class="text-yellow-600 font-semibold">4</span>
								</div>
								Experience Level
							</h2>
							
							<div class="space-y-8">
								<div class="question-group" data-required="true">
									<label class="block text-lg font-medium text-gray-900 mb-4">
										What is your experience level with psychedelics?
										<span class="text-red-500">*</span>
									</label>
									<div class="space-y-3">
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="experience_level" value="extensive" class="mt-1 mr-4" data-score="20">
											<div>
												<span class="font-medium text-gray-900">Extensive experience</span>
												<p class="text-sm text-gray-600">Multiple therapeutic journeys with various substances</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="experience_level" value="some" class="mt-1 mr-4" data-score="15">
											<div>
												<span class="font-medium text-gray-900">Some experience</span>
												<p class="text-sm text-gray-600">A few experiences with psychedelics</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="experience_level" value="minimal" class="mt-1 mr-4" data-score="10">
											<div>
												<span class="font-medium text-gray-900">Minimal experience</span>
												<p class="text-sm text-gray-600">One or two experiences</p>
											</div>
										</label>
										<label class="flex items-start p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200">
											<input type="radio" name="experience_level" value="none" class="mt-1 mr-4" data-score="5">
											<div>
												<span class="font-medium text-gray-900">No experience</span>
												<p class="text-sm text-gray-600">This would be my first psychedelic experience</p>
											</div>
										</label>
									</div>
								</div>

								<div class="question-group">
									<label for="additional_info" class="block text-lg font-medium text-gray-900 mb-4">
										Is there anything else you'd like to share about your readiness or concerns?
									</label>
									<textarea 
										id="additional_info" 
										name="additional_info" 
										rows="4" 
										class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
										placeholder="Share any additional thoughts, concerns, or information..."
									></textarea>
								</div>
							</div>
						</div>
					</div>

				</form>
			</div>
		</div>
	</section>

	<!-- Results Section (Initially Hidden) -->
	<section id="results-section" class="py-16 bg-gray-50 hidden">
		<div class="container mx-auto px-4">
			<div class="max-w-4xl mx-auto">
				<div class="bg-white rounded-lg shadow-xl p-8">
					<h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Your Enhanced Assessment Results</h2>
					
					<div id="results-content" class="space-y-8">
						<!-- Results will be populated by JavaScript -->
					</div>

					<div class="mt-8 text-center space-x-4">
						<a href="/get-started" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 inline-block">
							Schedule Consultation
						</a>
						<a href="/resources" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 inline-block">
							Explore Resources
						</a>
						<button id="download-results" class="bg-purple-600 hover:bg-purple-500 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
							Download Results
						</button>
					</div>
				</div>
			</div>
		</div>
	</section>
</BaseLayout>

<style>
	.assessment-step {
		display: none;
	}
	
	.assessment-step.active {
		display: block;
	}
	
	.question-group[data-required="true"] label:first-of-type::after {
		content: " *";
		color: #ef4444;
	}
	
	.progress-indicator {
		position: sticky;
		top: 0;
		z-index: 40;
		background: white;
		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	}
	
	@media (max-width: 768px) {
		.assessment-step {
			padding: 1rem;
		}
	}
</style>

<script>
	import { security } from '../lib/security.js';

	document.addEventListener('DOMContentLoaded', function() {
		let currentStep = 1;
		const totalSteps = 4;
		const formData: Record<string, any> = {};
		
		const form = document.getElementById('readiness-form') as HTMLFormElement;
		const prevBtn = document.getElementById('prev-btn') as HTMLButtonElement;
		const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
		const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
		const progressBar = document.getElementById('progress-bar') as HTMLElement;
		const progressText = document.getElementById('progress-text') as HTMLElement;
		const resultsSection = document.getElementById('results-section') as HTMLElement;
		const resultsContent = document.getElementById('results-content') as HTMLElement;

		// Initialize security
		security.secureForm(form);

		// Initialize
		updateProgress();
		loadSavedData();

		// Navigation event listeners
		prevBtn?.addEventListener('click', () => {
			if (currentStep > 1) {
				currentStep--;
				showStep(currentStep);
				updateProgress();
			}
		});

		nextBtn?.addEventListener('click', () => {
			if (validateCurrentStep() && currentStep < totalSteps) {
				saveCurrentStepData();
				currentStep++;
				showStep(currentStep);
				updateProgress();
			}
		});

		// Form submission
		form?.addEventListener('submit', function(e) {
			e.preventDefault();
			saveCurrentStepData();
			const assessment = calculateEnhancedReadiness(formData);
			displayEnhancedResults(assessment);
			resultsSection?.scrollIntoView({ behavior: 'smooth' });
		});

		// Auto-save functionality
		form?.addEventListener('change', () => {
			saveCurrentStepData();
			saveToLocalStorage();
		});

		function showStep(step: number) {
			document.querySelectorAll('.assessment-step').forEach(stepEl => {
				stepEl.classList.remove('active');
			});
			
			const currentStepEl = document.querySelector(`[data-step="${step}"]`);
			if (currentStepEl) {
				currentStepEl.classList.add('active');
			}

			// Update button visibility
			if (prevBtn) (prevBtn as any).disabled = step === 1;
			
			if (step === totalSteps) {
				nextBtn?.classList.add('hidden');
				submitBtn?.classList.remove('hidden');
			} else {
				nextBtn?.classList.remove('hidden');
				submitBtn?.classList.add('hidden');
			}
		}

		function updateProgress() {
			const percentage = (currentStep / totalSteps) * 100;
			if (progressBar) progressBar.style.width = `${percentage}%`;
			if (progressText) progressText.textContent = `Step ${currentStep} of ${totalSteps}`;
		}

		function validateCurrentStep(): boolean {
			const currentStepEl = document.querySelector(`[data-step="${currentStep}"]`);
			const requiredGroups = currentStepEl?.querySelectorAll('[data-required="true"]');
			
			let isValid = true;
			
			requiredGroups?.forEach(group => {
				const inputs = group.querySelectorAll('input[type="radio"], input[type="checkbox"]');
				const hasSelection = Array.from(inputs).some(input => (input as HTMLInputElement).checked);
				
				if (!hasSelection) {
					isValid = false;
					group.classList.add('border-red-300', 'bg-red-50');
					setTimeout(() => {
						group.classList.remove('border-red-300', 'bg-red-50');
					}, 3000);
				}
			});

			if (!isValid) {
				// Show validation message
				const message = document.createElement('div');
				message.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
				message.textContent = 'Please answer all required questions before proceeding.';
				currentStepEl?.insertBefore(message, currentStepEl.firstChild);
				
				setTimeout(() => {
					message.remove();
				}, 5000);
			}

			return isValid;
		}

		function saveCurrentStepData() {
			const currentStepEl = document.querySelector(`[data-step="${currentStep}"]`);
			const inputs = currentStepEl?.querySelectorAll('input, textarea, select');
			
			inputs?.forEach(input => {
				const inputEl = input as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement;
				if (inputEl.type === 'radio' || inputEl.type === 'checkbox') {
					const checkboxEl = inputEl as HTMLInputElement;
					if (checkboxEl.checked) {
						if (inputEl.type === 'checkbox') {
							if (!formData[inputEl.name]) formData[inputEl.name] = [];
							formData[inputEl.name].push(inputEl.value);
						} else {
							formData[inputEl.name] = inputEl.value;
						}
					}
				} else {
					formData[inputEl.name] = inputEl.value;
				}
			});
		}

		function saveToLocalStorage() {
			localStorage.setItem('readinessAssessmentData', JSON.stringify({
				formData,
				currentStep,
				timestamp: Date.now()
			}));
		}

		function loadSavedData() {
			const saved = localStorage.getItem('readinessAssessmentData');
			if (saved) {
				try {
					const data = JSON.parse(saved);
					// Load data if it's less than 24 hours old
					if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
						Object.assign(formData, data.formData);
						currentStep = data.currentStep || 1;
						
						// Restore form values
						Object.entries(formData).forEach(([name, value]) => {
							const inputs = document.querySelectorAll(`[name="${name}"]`);
							inputs.forEach(input => {
								const inputEl = input as HTMLInputElement | HTMLTextAreaElement;
								if (inputEl.type === 'radio' || inputEl.type === 'checkbox') {
									const checkboxEl = inputEl as HTMLInputElement;
									checkboxEl.checked = Array.isArray(value) ? value.includes(inputEl.value) : inputEl.value === value;
								} else {
									inputEl.value = value as string;
								}
							});
						});
						
						showStep(currentStep);
						updateProgress();
					}
				} catch (e) {
					console.error('Error loading saved data:', e);
				}
			}
		}

		function calculateEnhancedReadiness(responses: Record<string, any>) {
			let totalScore = 0;
			let maxPossibleScore = 100;
			const insights = {
				strengths: [] as string[],
				concerns: [] as string[],
				recommendations: [] as string[],
				riskFactors: [] as string[],
				readinessFactors: [] as string[]
			};

			// Enhanced scoring algorithm with weighted categories
			const categoryWeights = {
				mentalHealth: 0.4,
				intentions: 0.25,
				support: 0.25,
				experience: 0.1
			};

			// Mental Health Scoring (40% weight)
			let mentalHealthScore = 0;
			if (responses.mental_health) {
				const scores: Record<string, number> = { excellent: 25, good: 20, fair: 10, poor: 0 };
				mentalHealthScore = scores[responses.mental_health] || 0;
				
				if (responses.mental_health === 'excellent') {
					insights.strengths.push('Excellent mental health foundation');
					insights.readinessFactors.push('Strong emotional stability');
				} else if (responses.mental_health === 'poor') {
					insights.concerns.push('Significant mental health challenges present');
					insights.recommendations.push('Stabilize mental health before proceeding');
					insights.riskFactors.push('Current mental health instability');
				}
			}

			// Medication scoring
			if (responses.medications) {
				const medScores: Record<string, number> = {
					none: 5,
					stable: 10,
					recent_changes: -5,
					contraindicated: -25
				};
				mentalHealthScore += medScores[responses.medications] || 0;
				
				if (responses.medications === 'contraindicated') {
					insights.riskFactors.push('Taking contraindicated medications');
					insights.recommendations.push('Consult with prescribing physician about medication interactions');
				}
			}

			// Apply mental health weight
			totalScore += mentalHealthScore * categoryWeights.mentalHealth;

			// Intentions Scoring (25% weight)
			let intentionsScore = 0;
			if (responses.motivation) {
				const motivationScores: Record<string, number> = {
					healing: 20,
					depression: 18,
					growth: 15,
					spiritual: 12
				};
				intentionsScore = motivationScores[responses.motivation] || 5;
				
				if (responses.motivation === 'healing') {
					insights.strengths.push('Clear therapeutic intention');
					insights.readinessFactors.push('Focused on healing and growth');
				}
			}

			// Apply intentions weight
			totalScore += intentionsScore * categoryWeights.intentions;

			// Support System Scoring (25% weight)
			let supportScore = 0;
			if (responses.support_person) {
				const supportScores: Record<string, number> = {
					yes_experienced: 25,
					yes_willing: 15,
					no: 0
				};
				supportScore += supportScores[responses.support_person] || 0;
			}

			if (responses.environment) {
				const envScores: Record<string, number> = {
					ideal: 15,
					good: 10,
					uncertain: 0
				};
				supportScore += envScores[responses.environment] || 0;
			}

			// Apply support weight
			totalScore += supportScore * categoryWeights.support;

			// Experience Scoring (10% weight)
			let experienceScore = 0;
			if (responses.experience_level) {
				const expScores: Record<string, number> = {
					extensive: 20,
					some: 15,
					minimal: 10,
					none: 5
				};
				experienceScore = expScores[responses.experience_level] || 0;
				
				if (responses.experience_level === 'none') {
					insights.recommendations.push('Consider starting with preparation and education');
					insights.readinessFactors.push('Open to new experiences');
				}
			}

			// Apply experience weight
			totalScore += experienceScore * categoryWeights.experience;

			// Calculate final percentage
			const readinessPercentage = Math.max(0, Math.min(100, (totalScore / maxPossibleScore) * 100));

			// Determine readiness level
			let readinessLevel = 'Not Ready';
			let readinessColor = 'text-red-600';
			let readinessDescription = 'Significant preparation needed before proceeding';

			if (readinessPercentage >= 80) {
				readinessLevel = 'Highly Ready';
				readinessColor = 'text-green-600';
				readinessDescription = 'Excellent readiness for psychedelic therapy';
			} else if (readinessPercentage >= 60) {
				readinessLevel = 'Moderately Ready';
				readinessColor = 'text-yellow-600';
				readinessDescription = 'Good foundation with some areas for improvement';
			} else if (readinessPercentage >= 40) {
				readinessLevel = 'Somewhat Ready';
				readinessColor = 'text-orange-600';
				readinessDescription = 'Basic readiness with important preparation needed';
			}

			return {
				score: Math.round(readinessPercentage),
				level: readinessLevel,
				color: readinessColor,
				description: readinessDescription,
				insights,
				responses
			};
		}

		function displayEnhancedResults(assessment: any) {
			if (!resultsContent) return;

			resultsContent.innerHTML = `
				<div class="text-center mb-8">
					<div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-3xl font-bold mb-4">
						${assessment.score}%
					</div>
					<h3 class="text-2xl font-bold ${assessment.color} mb-2">${assessment.level}</h3>
					<p class="text-gray-600">${assessment.description}</p>
				</div>

				<div class="grid md:grid-cols-2 gap-8">
					<div class="bg-green-50 rounded-lg p-6">
						<h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
							<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
								<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
							</svg>
							Strengths & Readiness Factors
						</h4>
						<ul class="space-y-2">
							${[...assessment.insights.strengths, ...assessment.insights.readinessFactors]
								.map(item => `<li class="text-green-700">• ${item}</li>`).join('')}
						</ul>
					</div>

					<div class="bg-red-50 rounded-lg p-6">
						<h4 class="text-lg font-semibold text-red-800 mb-4 flex items-center">
							<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
								<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
							</svg>
							Areas of Concern
						</h4>
						<ul class="space-y-2">
							${[...assessment.insights.concerns, ...assessment.insights.riskFactors]
								.map(item => `<li class="text-red-700">• ${item}</li>`).join('')}
						</ul>
					</div>
				</div>

				<div class="bg-blue-50 rounded-lg p-6 mt-8">
					<h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
						<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
							<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
						</svg>
						Personalized Recommendations
					</h4>
					<ul class="space-y-2">
						${assessment.insights.recommendations.length > 0
							? assessment.insights.recommendations.map((item: string) => `<li class="text-blue-700">• ${item}</li>`).join('')
							: '<li class="text-blue-700">• Continue with your current preparation approach</li><li class="text-blue-700">• Consider scheduling a consultation to discuss next steps</li>'
						}
					</ul>
				</div>
			`;

			// Show results section
			resultsSection?.classList.remove('hidden');

			// Setup download functionality
			const downloadBtn = document.getElementById('download-results');
			downloadBtn?.addEventListener('click', () => {
				downloadResults(assessment);
			});
		}

		function downloadResults(assessment: any) {
			const resultsText = `
PSYCHEDELIC READINESS ASSESSMENT RESULTS
Generated: ${new Date().toLocaleDateString()}

OVERALL READINESS: ${assessment.score}% - ${assessment.level}
${assessment.description}

STRENGTHS & READINESS FACTORS:
${[...assessment.insights.strengths, ...assessment.insights.readinessFactors]
	.map(item => `• ${item}`).join('\n')}

AREAS OF CONCERN:
${[...assessment.insights.concerns, ...assessment.insights.riskFactors]
	.map(item => `• ${item}`).join('\n')}

RECOMMENDATIONS:
${assessment.insights.recommendations.length > 0
	? assessment.insights.recommendations.map((item: string) => `• ${item}`).join('\n')
	: '• Continue with your current preparation approach\n• Consider scheduling a consultation to discuss next steps'
}

---
This assessment is for informational purposes only and does not constitute medical advice.
Please consult with qualified healthcare professionals before making any decisions about psychedelic therapy.
			`.trim();

			const blob = new Blob([resultsText], { type: 'text/plain' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `readiness-assessment-results-${new Date().toISOString().split('T')[0]}.txt`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}
	});
</script>
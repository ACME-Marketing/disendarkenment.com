---
import BaseLayout from '../layouts/BaseLayout.astro';
import { graphQLClient, gql } from '../lib/graphql';

const GET_DISENDARKENMENT_POSTS = gql`
  query GetDisendarkenmentPosts {
    posts(where: { tagSlugIn: ["disendarkenment", "all"] }) {
      nodes {
        title
        uri
        content
        featuredImage {
          node {
            sourceUrl
            altText
            mediaDetails {
              width
              height
            }
          }
        }
        tags {
          nodes {
            name
            slug
          }
        }
      }
    }
  }
`;

let posts = [];
try {
  const data = await graphQLClient.request(GET_DISENDARKENMENT_POSTS);
  posts = data.posts.nodes;
} catch (error) {
  console.error("Error fetching posts for disendarkenment.com:", error);
}
---

<BaseLayout title="Disendarkenment">
	<header>
		<h1>Welcome to Disendarkenment</h1>
	</header>

	<main class="container">
		{posts.length > 0 ? (
			<ul class="post-list">
				{posts.map((post) => (
					<li class="post-card">
						{post.featuredImage && post.featuredImage.node && (
							<img src={post.featuredImage.node.sourceUrl} alt={post.featuredImage.node.altText || post.title} width={post.featuredImage.node.mediaDetails.width} height={post.featuredImage.node.mediaDetails.height} class="post-image" />
						)}
						<div class="post-content">
							<a href={post.uri}><h2>{post.title}</h2></a>
							{post.tags && post.tags.nodes.length > 0 && (
								<p class="post-tags">Tags: {post.tags.nodes.map(tag => tag.name).join(', ')}</p>
							)}
							<div class="post-body" set:html={post.content} />
						</div>
					</li>
				))}
			</ul>
		) : (
			<p>No posts found. Please add some posts in your WordPress CMS with the tag "disendarkenment" or "all".</p>
		)}
	</main>

	<footer>
		<p>&copy; {new Date().getFullYear()} Disendarkenment. All rights reserved.</p>
	</footer>
</BaseLayout>